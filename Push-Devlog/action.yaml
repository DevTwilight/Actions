name: Push-Devlog

description: |
  Composite GitHub Action that generates release notes from commit messages and writes to a custom file.

inputs:
  prefix:
    description: |
      List of commit message prefixes to include (one per line).
    required: true

  section:
    description: |
      Optional mapping of prefix to section heading. Format: prefix:Section Heading
    required: false

  file:
    description: |
      Name of the output file to write the release notes (e.g., Devlog.md).
    required: true

outputs:
  version:
    description: "Extracted version number from the version bump commit (e.g., 1.2.3 or 1.2.3-dev)."

runs:
  using: "composite"
  steps:
    - name: Generate release notes and write to file
      id: generate
      shell: pwsh
      run: |
        Write-Host "[INFO] Starting release notes generation..."

        $prefixInput = "${{ inputs.prefix }}"
        $sectionInput = "${{ inputs.section }}"
        $fileName = "${{ inputs.file }}"

        $prefixes = $prefixInput -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "" }
        $sectionMap = @{}

        if ($sectionInput -ne "") {
            Write-Host "[INFO] Creating sections..."
            foreach ($line in $sectionInput -split "`n") {
                if ($line -match "^(.*?):(.*)$") {
                    $sectionMap[$matches[1].Trim()] = $matches[2].Trim()
                }
            }
        }

        Write-Host "[INFO] Extracting commit log..."
        $log = git log --date-order --pretty=format:"%H|%s"
        $commits = $log -split "`n" | ForEach-Object {
            $parts = $_ -split "\|", 2
            [PSCustomObject]@{ Hash = $parts[0]; Message = $parts[1] }
        }

        Write-Host "[INFO] Searching for version bump commits..."
        $versionBumps = $commits | Where-Object { $_.Message -match '^Bump version to \d+\.\d+\.\d+(-dev)?$' }

        if ($versionBumps.Count -lt 1) {
            Write-Host "[INFO] No previous version bump found. Creating first Devlog."
            $version = "0.1.0-dev"
            echo "::set-output name=version::$version"
            Set-Content -Path $fileName -Value "# Devlog - Version $version`n`n_No previous version bump found. First devlog created._"
            exit 0
        }

        $currentBump = $versionBumps[0]
        $versionMatch = [regex]::Match($currentBump.Message, '\d+\.\d+\.\d+(-dev)?')
        $version = if ($versionMatch.Success) { $versionMatch.Value } else { "unknown" }

        echo "::set-output name=version::$version"
        Write-Host "[INFO] Found version bump: $version"

        if ($versionBumps.Count -lt 2) {
            Write-Host "[INFO] This is the first version bump. Writing single version Devlog."
            Set-Content -Path $fileName -Value "# Devlog - Version $version`n`n_Initial release notes._"
            exit 0
        }

        $previousBump = $versionBumps[1]

        $startIndex = ($commits | Select-Object -Index 0..($commits.Count - 1) | Where-Object { $_.Hash -eq $currentBump.Hash }).Index
        $endIndex = ($commits | Select-Object -Index 0..($commits.Count - 1) | Where-Object { $_.Hash -eq $previousBump.Hash }).Index

        if ($startIndex -eq $null -or $endIndex -eq $null -or $startIndex -le $endIndex) {
            Write-Host "[ERROR] Invalid commit range for release notes."
            exit 1
        }

        $rangeCommits = $commits[$endIndex + 1 .. ($startIndex - 1)]
        $sections = @{}

        foreach ($commit in $rangeCommits) {
            foreach ($prefix in $prefixes) {
                if ($commit.Message.ToLower().StartsWith($prefix.ToLower())) {
                    $clean = $commit.Message.Substring($prefix.Length).Trim()
                    $heading = if ($sectionMap.ContainsKey($prefix)) { $sectionMap[$prefix] } else { $prefix }
                    if (-not $sections.ContainsKey($heading)) {
                        $sections[$heading] = @()
                    }
                    $sections[$heading] += "- $clean"
                    break
                }
            }
        }

        Write-Host "[INFO] Writing Devlog to file: $fileName"
        $lines = @()
        $lines += "# Devlog - Version $version"
        $lines += ""

        foreach ($heading in $sections.Keys) {
            $lines += "## $heading"
            $lines += $sections[$heading]
            $lines += ""
        }

        $lines | Set-Content -Path $fileName -Encoding UTF8
        Write-Host "[INFO] Devlog created successfully: $fileName"
